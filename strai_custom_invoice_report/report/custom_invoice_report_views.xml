<?xml version="1.0" encoding="UTF-8"?>

<odoo>
    <template id="external_layout_standard_flyt_custom_invoice_report" name="FLYT Custom Invoice Report" inherit_id="web.external_layout_standard">
        <div t-field="company.report_header" position="replace">
            <div name="company_address" position="move"/>
        </div>
        <div class="pt-5" position="attributes">
            <attribute name="class">pt-0</attribute>
        </div>
        <div class="col-3 mb4" position="attributes">
            <attribute name="class">col-2 mb4</attribute>
        </div>
        <div t-field="company.report_footer" position="replace">
            <div class="row">
                <div class="col-4 text-center">
                    <img src="/strai_custom_invoice_report/static/src/img/phone.png" width="19" height="15"/>
                    <t t-esc="company.phone"/>
                </div>
                <div class="col-4 text-center">
                    <img src="/strai_custom_invoice_report/static/src/img/email.png" width="19" height="15"/>
                    <t t-esc="company.email"/>
                </div>
                <div class="col-4 text-center">
                    <img src="/strai_custom_invoice_report/static/src/img/website.png" width="19" height="15"/>
                    <t t-esc="company.website"/>
                </div>
            </div>
            <div class="col-12 text-center" style="top: 12px">
                <span>Company registered</span> <span t-esc="company.vat"/>
            </div>
        </div>

        <xpath expr="//img[1]" position="attributes">
          <attribute name="style">max-height:132px;</attribute>
        </xpath>

    </template>

    <template id="report_invoice_document_flyt_custom_invoice_report" inherit_id="account.report_invoice_document" primary="True">
        <xpath expr="//div[hasclass('page')]" position="before">
            <style>
                .o_main_table th {
                    border-bottom: 2px solid #dee2e6;
                    border-left: 0px;
                    border-right: 0px;
                }
                .o_main_table td, .o_main_table tr {
                    border-left: 0px;
                    border-right: 0px;
                }
                .table &gt; :not(:first-child) {
                    border-top: 2px solid #dee2e6;
                }
                .o_main_table tbody &gt; tr:nth-of-type(even) &gt; * {
                    background-color: #fafafa;
                }
            </style>
            <t t-set="sale_orders" t-value="o.invoice_line_ids.mapped('sale_line_ids').mapped('order_id')"/>
            <t t-set="sale_order" t-value="sale_orders and sale_orders[0] or env['sale.order']"/>
            <t t-set="delivery_date"
               t-value="sale_order.picking_ids.filtered(lambda picking: picking.state == 'done').mapped('date_done')"/>
            <t t-set="information_block">
                <span t-if="o.partner_id and o.partner_id.parent_id.name" t-field="o.partner_id.parent_id.name"></span>
                <span t-elif="o.partner_id and o.partner_id.name" t-field="o.partner_id.name"></span>                
                <address t-field="o.partner_id" t-options="{&quot;widget&quot;: &quot;contact&quot;, &quot;fields&quot;: [&quot;address&quot;], &quot;no_marker&quot;: True}"/>
                <strong t-if="o.partner_shipping_id">Delivery address</strong><br/>
                <span t-if="o.partner_shipping_id and o.partner_shipping_id.parent_id.name" t-field="o.partner_shipping_id.parent_id.name"></span>
                <span t-elif="o.partner_shipping_id and o.partner_shipping_id.name" t-field="o.partner_shipping_id.name"></span>
                <address t-if="o.partner_shipping_id" t-field="o.partner_shipping_id" t-options="{&quot;widget&quot;: &quot;contact&quot;, &quot;fields&quot;: [&quot;address&quot;], &quot;no_marker&quot;: True}"/>
            </t>
            <t t-set="address">
                <div name="invoice_info">
                    <div class="row" t-if="o.ref">
                        <div class="col-5">Remarks:</div>
                        <div class="col-6">
                            <span t-field="o.ref"/>
                        </div>
                    </div>
                    <!-- <div class="row" t-if="o.remarks">
                        <div class="col-5">Remarks:</div>
                        <div class="col-6">
                            <span t-field="o.remarks"/>
                        </div>
                    </div>-->
                    <div class="row" t-if="o.invoice_date">
                        <div class="col-5">Invoice Date:</div>
                        <div class="col-6">
                            <span t-field="o.invoice_date"/>
                        </div>
                    </div>
                    <div class="row" t-if="o.invoice_date_due">
                        <div class="col-5">Due Date:</div>
                        <div class="col-6">
                            <span t-field="o.invoice_date_due"/>
                        </div>
                    </div>
                    <div class="row" t-if="o.partner_bank_id">
                        <div class="col-5">Bank account:</div>
                        <div class="col-6">
                            <span t-field="o.partner_bank_id.acc_number"/>
                        </div>
                    </div>
                    <div class="row" t-if="o.payment_reference">
                        <div class="col-5">KID Number:</div>
                        <div class="col-6">
                            <span t-field="o.payment_reference"/>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-5">Total price:</div>
                        <div class="col-6">
                            <span t-field="o.amount_total"/>
                        </div>
                    </div>
                </div>
            </t>
        </xpath>
        <xpath expr="//div[@name='invoice_info']" position="before">
            <xpath expr="//h2" position="move"/>
        </xpath>
        <xpath expr="//th[@name='th_taxes']" position="attributes">
            <attribute name="t-attf-class">text-end</attribute>
        </xpath>
       <xpath expr="//t[@name='account_invoice_line_accountable']/td[5]" position="attributes">
            <attribute name="t-attf-class">text-end</attribute>
       </xpath> 
        <xpath expr="//th[@name='th_description']" position="attributes">
            <attribute name="style">max-width:250px;</attribute>
        </xpath>
        <xpath expr="//td[@name='account_invoice_line_name']" position="attributes">
            <attribute name="style">max-width:250px;</attribute>
        </xpath>             
        <xpath expr="//span[@t-field='line.discount']" position="after">
            <span>%</span>
        </xpath>        
        <xpath expr="//span[@t-field='line.discount']" position="attributes">
            <attribute name="t-options">{"widget": "float", "precision": 2}</attribute>
        </xpath>

        <xpath expr="//h2" position="attributes">
            <attribute name="class">h3</attribute>
        </xpath>
        <xpath expr="//div[@id='informations']" position="replace">
            <div id="informations" class="row mt-4 mb-1">
                <div class="col-auto col-3 mw-100 mb-2" t-if="sale_order" name="sale_order">
                    <strong>Order:</strong>
                    <p class="m-0" t-field="sale_order.name"/>
                </div>
                <div class="col-auto col-3 mw-100 mb-2" t-if="sale_order" name="date_order">
                    <strong>Order Date:</strong>
                    <p class="m-0" t-field="sale_order.date_order" t-options="{'widget': 'date'}"/>
                </div>
                <div class="col-auto col-3 mw-100 mb-2" t-if="delivery_date"
                     name="commitment_date">
                    <strong>Delivery date:</strong>
                    <p class="m-0">
                      <span t-esc="min(delivery_date)" t-options="{'widget': 'date'}"/> 
                    </p>
                </div>
                <div class="col-auto col-3 mw-100 mb-2" t-if="sale_order and sale_order.user_id" name="user_id">
                    <strong>Sales Person:</strong>
                    <p class="m-0" t-field="sale_order.user_id"/>
                </div>
            </div>
        </xpath>
        <xpath expr="//span[@t-field='line.quantity']" position="replace">
            <span t-esc="('%.4f' % line.quantity).rstrip('0').rstrip('.')"/>
        </xpath>
            <xpath expr="//table[@name='invoice_line_table']" position="attributes">
                <attribute name="class">table table-sm o_main_table table-striped</attribute>
                <attribute name="t-if">not o.company_id.flyt_inv_pdf_sections</attribute>
            </xpath>

            <t t-elif="line.display_type == 'line_section'" position="replace">
                <t t-elif="line.display_type == 'line_section'">
                    <td colspan="99" style="background-color: #dee2e6">
                        <span t-field="line.name" t-options="{'widget': 'text'}"/>
                    </td>
                    <t t-set="current_section" t-value="line"/>
                    <t t-set="current_subtotal" t-value="0"/>
                </t>
            </t>

            <xpath expr="//table[@name='invoice_line_table']" position="after">
                <t t-if="o.company_id.flyt_inv_pdf_sections">
                    <table class="table o_main_table table-striped" name="invoice_line_table">
                        <thead>
                            <tr>
                                <th name="th_description" class="text-start"><span>Description</span></th>
                                <th name="th_subtotal" class="text-end">Amount</th>
                                <th name="th_taxes" t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}"><span>Taxes</span></th>
                                <th name="th_subtotal" class="text-end">Total Price</th>
                            </tr>
                        </thead>
                        <tbody class="invoice_tbody">
                            <t t-foreach="o._get_invoice_lines_group_by_section()" t-as="line">
                                <tr>
                                    <td><span t-out="line.get('section')"/></td>
                                    <td class="text-end"><span t-out="line.get('price_subtotal')"
                                        t-options='{"widget": "monetary", "display_currency": o.currency_id}'/></td>
                                    <td class="text-end"><span t-out="line.get('tax_ids')"/></td>
                                    <td class="text-end"><span t-out="line.get('price_subtotal')"
                                        t-options='{"widget": "monetary", "display_currency": o.currency_id}'/></td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </t>
            </xpath>
        <xpath expr="//p[@name='payment_communication']" position="replace"/>
        <xpath expr="//span[@name='payment_term']" position="replace"/>
        <xpath expr="//div[@name='comment']" position="replace"/>
        <xpath expr="//p[@name='note']" position="replace"/>
        <!-- <xpath expr="//p[@name='incoterm']" position="replace"/> -->
        <xpath expr="//div[@id='qrcode']" position="replace"/>
        <xpath expr="//div[hasclass('clearfix')]" position="after">
            <div class="row">
                <div class="col-6"/>
                <div class="col-6">
                    <!-- <p t-if="o.invoice_payment_term_id" name="payment_term">
                        <span t-field="o.invoice_payment_term_id.note"/>
                    </p> -->
                    <p t-if="not is_html_empty(o.fiscal_position_id.note)" name="note">
                        <span t-field="o.fiscal_position_id.note"/>
                    </p>
                    <!-- <p t-if="o.invoice_incoterm_id" name="incoterm">
                        <strong>Incoterm:</strong>
                        <span t-field="o.invoice_incoterm_id.code"/>
                        -
                        <span t-field="o.invoice_incoterm_id.name"/>
                    </p>
                    <div id="qrcode" t-if="o.display_qr_code and o.amount_residual > 0">
                        <p t-if="qr_code_urls.get(o.id)">
                            <strong class="text-center">Scan me with your banking app.</strong>
                            <br/>
                            <br/>
                            <img class="border border-dark rounded" t-att-src="qr_code_urls[o.id]"/>
                        </p>
                    </div> -->
                </div>
            </div>
        <div class="row"> 
            <div class="page">
                <p t-if="not is_html_empty(o.narration)" name="comment">
                    <span t-field="o.narration"/>
                </p>
            </div>
        </div>
        </xpath>

        <xpath expr="//span[text()='PROFORMA' and @t-else]" position="attributes">
            <attribute name="style">display:none;</attribute>
        </xpath>
    </template>

    <template id="report_invoice" inherit_id="account.report_invoice">
        <xpath expr="//t[@t-call='account.report_invoice_document']" position="attributes">
            <attribute name="t-call">strai_custom_invoice_report.report_invoice_document_flyt_custom_invoice_report</attribute>
        </xpath>
    </template>
    <!-- <template id="report_invoice_with_payments" inherit_id="account.report_invoice_with_payments">
        <xpath expr="//t[@t-call='account.report_invoice_document']" position="attributes">
            <attribute name="t-call">strai_custom_invoice_report.report_invoice_document_flyt_custom_invoice_report</attribute>
        </xpath>
    </template> -->
</odoo>
